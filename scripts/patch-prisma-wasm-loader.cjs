/* eslint-disable no-console */
const fs = require('node:fs');
const path = require('node:path');

const loaders = [
  path.join(__dirname, '..', 'node_modules', '.prisma', 'client', 'wasm-worker-loader.mjs'),
  path.join(__dirname, '..', 'node_modules', '.prisma', 'client', 'wasm-edge-light-loader.mjs'),
];

const header = `/* !!! This is code generated by Prisma. Do not edit directly. !!!
/* eslint-disable */`;

const body = `
import { readFile } from 'node:fs/promises';
import { fileURLToPath } from 'node:url';

const loadWasmModule = async () => {
  const filepath = fileURLToPath(new URL('./query_engine_bg.wasm', import.meta.url));
  const wasmBuffer = await readFile(filepath);
  const wasmModule = await WebAssembly.compile(wasmBuffer);
  return { default: wasmModule };
};

export default loadWasmModule();
`.trimStart();

const content = `${header}\n${body}\n`;

for (const loaderPath of loaders) {
  try {
    if (!fs.existsSync(loaderPath)) {
      continue;
    }
    const existing = fs.readFileSync(loaderPath, 'utf8');
    if (existing === content) {
      continue;
    }
    fs.writeFileSync(loaderPath, content, 'utf8');
    console.log(`[patch-prisma-wasm-loader] Patched ${path.relative(process.cwd(), loaderPath)}`);
  } catch (error) {
    console.warn(`[patch-prisma-wasm-loader] Failed to patch ${loaderPath}:`, error);
  }
}
